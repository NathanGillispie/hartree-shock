
import pytest

import numpy as np
from hf import build_molecule
from rhf import RHF
from utils import molecular_grid

@pytest.fixture
def do_scf():
    wfn = RHF(*build_molecule("tests/molecules/water.xyz", "tests/basis/sto-3g.gbs"))
    wfn.compute_E()
    grid = molecular_grid(wfn, spacing=1, extension=1)
    return grid.get_grid_eval()

def test_points(do_scf):
    points, _ = do_scf
    points_ref = np.array([[-3., -2., -1.],  [-3., -2.,  0.],  [-3., -1., -1.],
         [-3., -1.,  0.],  [-3.,  0., -1.],  [-3.,  0.,  0.],  [-3.,  1., -1.],
         [-3.,  1.,  0.],  [-2., -2., -1.],  [-2., -2.,  0.],  [-2., -1., -1.],
         [-2., -1.,  0.],  [-2.,  0., -1.],  [-2.,  0.,  0.],  [-2.,  1., -1.],
         [-2.,  1.,  0.],  [-1., -2., -1.],  [-1., -2.,  0.],  [-1., -1., -1.],
         [-1., -1.,  0.],  [-1.,  0., -1.],  [-1.,  0.,  0.],  [-1.,  1., -1.],
         [-1.,  1.,  0.],  [ 0., -2., -1.],  [ 0., -2.,  0.],  [ 0., -1., -1.],
         [ 0., -1.,  0.],  [ 0.,  0., -1.],  [ 0.,  0.,  0.],  [ 0.,  1., -1.],
         [ 0.,  1.,  0.],  [ 1., -2., -1.],  [ 1., -2.,  0.],  [ 1., -1., -1.],
         [ 1., -1.,  0.],  [ 1.,  0., -1.],  [ 1.,  0.,  0.],  [ 1.,  1., -1.],
         [ 1.,  1.,  0.],  [ 2., -2., -1.],  [ 2., -2.,  0.],  [ 2., -1., -1.],
         [ 2., -1.,  0.],  [ 2.,  0., -1.],  [ 2.,  0.,  0.],  [ 2.,  1., -1.],
         [ 2.,  1.,  0.]])

    points_diff = np.abs(points - points_ref).sum()
    assert points_diff < 1e-6

def test_eval(do_scf):
    _, eval = do_scf
    eval_ref = np.array([-1.16965616e-03,  3.91607989e-19, -3.01759685e-03,  1.30027106e-18,
       -3.63583811e-03,  6.65887101e-18, -2.04248526e-03,  1.30897467e-17,
       -7.92042013e-03, -2.55218507e-18, -2.17750131e-02, -6.78369338e-18,
       -2.71177594e-02,  3.82554307e-18, -1.41536066e-02,  4.30651262e-17,
       -2.74185084e-02, -6.92872861e-18, -1.16345497e-01, -4.32962204e-17,
       -1.70203521e-01, -6.04622117e-17, -5.88541034e-02,  1.27177791e-17,
       -4.51992620e-02, -9.26177599e-33, -2.64304970e-01, -3.60000595e-32,
       -4.22134864e-01,  7.61660281e-32, -1.14314602e-01,  3.83709058e-32,
       -2.74185084e-02,  6.92872861e-18, -1.16345497e-01,  4.32962204e-17,
       -1.70203521e-01,  6.04622117e-17, -5.88541034e-02, -1.27177791e-17,
       -7.92042013e-03,  2.55218507e-18, -2.17750131e-02,  6.78369338e-18,
       -2.71177594e-02, -3.82554307e-18, -1.41536066e-02, -4.30651262e-17])

    eval_diff = np.abs(eval[4] - eval_ref).sum()
    assert eval_diff < 1e-6

